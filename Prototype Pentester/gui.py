import tkinter as tk
from tkinter import ttk, messagebox
import subprocess
import json
import os

# Typowe prędkości CAN
BITRATES = [125000, 250000, 500000, 1000000]
# Priorytety z normy J1939 (tylko najwyższe 3 bity)
J1939_PRIOS = [0x00000000, 0x04000000, 0x08000000, 0x0C000000,
               0x10000000, 0x14000000, 0x18000000, 0x1C000000]

CONFIG_FILE = "test_config.json"

def save_config(config):
    with open(CONFIG_FILE, "w") as f:
        json.dump(config, f)

def run_scripts():
    try:
        subprocess.Popen(["python", "logger.py"])
        subprocess.run(["python", "sender.py", CONFIG_FILE])
    except Exception as e:
        messagebox.showerror("Błąd", str(e))

def start_test():
    try:
        config = {
            "start_channel": int(channel_var.get()),
            "bitrate1": int(bitrate1_var.get()),
            "bitrate2": int(bitrate2_var.get()),
            "priolist": [int(prios_listbox.get(i), 16) for i in prios_listbox.curselection()],
            "ramki": int(frame_count_var.get()),
            "delay": float(delay_var.get())
        }
        save_config(config)
        run_scripts()
    except Exception as e:
        messagebox.showerror("Błąd konfiguracji", str(e))

# GUI init
root = tk.Tk()
root.title("CAN Test GUI")

frame = ttk.Frame(root, padding=10)
frame.grid(row=0, column=0)

# Kanał początkowy
channel_var = tk.StringVar(value="0")
ttkw = {"padx": 5, "pady": 5, "sticky": "w"}
ttk.Label(frame, text="Kanał początkowy:").grid(row=0, column=0, **ttkw)
ttk.Entry(frame, textvariable=channel_var).grid(row=0, column=1, **ttkw)

# Prędkości CAN
bitrate1_var = tk.StringVar(value="250000")
bitrate2_var = tk.StringVar(value="500000")
ttk.Label(frame, text="Bitrate kanału 1:").grid(row=1, column=0, **ttkw)
ttk.Combobox(frame, textvariable=bitrate1_var, values=BITRATES).grid(row=1, column=1, **ttkw)
ttk.Label(frame, text="Bitrate kanału 2:").grid(row=2, column=0, **ttkw)
ttk.Combobox(frame, textvariable=bitrate2_var, values=BITRATES).grid(row=2, column=1, **ttkw)

# Lista priorytetów
ttk.Label(frame, text="Priorytety (hex):").grid(row=3, column=0, **ttkw)
prios_listbox = tk.Listbox(frame, selectmode="multiple", height=8)
for prio in J1939_PRIOS:
    prios_listbox.insert(tk.END, hex(prio))
prios_listbox.grid(row=3, column=1, **ttkw)

# Liczba ramek i delay
frame_count_var = tk.StringVar(value="15")
delay_var = tk.StringVar(value="0.005")
ttk.Label(frame, text="Liczba ramek:").grid(row=4, column=0, **ttkw)
ttk.Entry(frame, textvariable=frame_count_var).grid(row=4, column=1, **ttkw)
ttk.Label(frame, text="Opóźnienie (s):").grid(row=5, column=0, **ttkw)
ttk.Entry(frame, textvariable=delay_var).grid(row=5, column=1, **ttkw)

# Przycisk start
ttk.Button(frame, text="Start", command=start_test).grid(row=6, column=0, columnspan=2, pady=10)

root.mainloop()

from time import sleep

import can
import signal
import csv
import time

# Vector settings
initial_channel = 1  # start channel
bitrate1 = 250000  # bitrate 250 kbps
bitrate2 = 250000  # in case of second channel in different bitrate
# CAN init
bus = can.interface.Bus(channel=initial_channel, interface='vector', bitrate=bitrate1)

# flag running
running = True

# flag on switching file/channel
switched_file = False

# CAN1.csv open and write
csv_file = open('CAN1.csv', mode='w', newline='')
writer = csv.writer(csv_file)  # Użyj csv.writer do prostszego zapisu

def on_message_received(message):
    global running
    global bus
    global csv_file
    global writer
    global switched_file

    can_id = hex(message.arbitration_id)
    #print(can_id)  # debug id printing

    # csv ID writing
    writer.writerow([can_id])

    # checking on switch demand
    if (not switched_file) and message.arbitration_id == 0x8 and len(message.data) >= 4:
        if message.data[0] == 2 and message.data[1] == 1 and message.data[2] == 3 and message.data[3] == 7:
            print("Warunki spełnione: CAN1.csv zapisane, stworzono CAN2.csv i switch kanałów między skryptami")
            time.sleep(20)
            # save and close CAN1.csv
            csv_file.close()

            # open writer on CAN2.csv
            csv_file = open('CAN2.csv', mode='w', newline='')
            writer = csv.writer(csv_file)

            switched_file = True  # setting the switching flag

            # close current bus
            bus.shutdown()
            # set new bus with second channel
            bus = can.interface.Bus(channel=0, interface='vector', bitrate=bitrate2)

def signal_handler(sig, frame):
    global running
    running = False
    print("Zatrzymywanie programu...")

signal.signal(signal.SIGINT, signal_handler)

print("Rozpoczęto odczyt ramek CAN...")

try:
    while running:
        message = bus.recv(timeout=0.1)
        if message is not None:
            on_message_received(message)
except Exception as e:
    print(f"Błąd: {e}")
finally:
    bus.shutdown()
    # close and save CAN2.csv
    try:
        csv_file.close()
    except Exception:
        pass
    print("Program zakończony.")
